[

%%
%% logger config
{lager, [
   {handlers, [
      {lager_console_backend, [notice, {lager_default_formatter, [time, " [",severity,"] ", message, "\n"]}]}
     ,{lager_file_backend,    [{file, "log/access.log"}, {level, none}, {formatter, lager_default_formatter},{formatter_config, [date, " ", time, " ", message, "\n"]}]}
   ]},
   {traces, [
      {{lager_file_backend, "log/access.log"}, [{module, knet_http}], notice}
   ]}
]},

%%
%% rest api
{restd, [
   {default, [
      {port,  "http://*:8080"},
      {pool, 10},
      {route, [
         %% 
         %% authorization grant 
         {"/oauth2/authorize",   oauth2_restapi_auth}

         %%
         %% token endpoint: issue and validate
        ,{"/oauth2/token",       oauth2_restapi_token}
        ,{"/oauth2/introspect",  oauth2_restapi_introspect}
        ,{"/oauth2/jwks",        oauth2_restapi_jwks}

         %%
         %% application registration
        ,{"/oauth2/client",      oauth2_restapi_client}
        ,{"/oauth2/client/:id",  oauth2_restapi_client}
        ,{"/oauth2/account",     oauth2_restapi_account}

         %% 
         %% static resources
        ,{"/authorize",          restd_api_webapp, [{htdoc, oauth2}, {path, widget}, {file, <<"signin.html">>}]}
        ,{"/css/:file",          restd_api_webapp, [{htdoc, oauth2}, {path, css}]}
        ,{"/js/:file",           restd_api_webapp, [{htdoc, oauth2}, {path, js}]}
        ,{"/widget/:file",       restd_api_webapp, [{htdoc, oauth2}, {path, widget}]}
      ]}
   ]}
]},

%%
%%
{permit, [
   %%
   %% RFC 7519  
   %%   4.1.1.  "iss" (Issuer) Claim
   {issuer, {env, "OAUTH2_ISSUER", "http://localhost:8080"}}

   %%
   %% secret key to sign the token
   %% (consider usage of aws kms or cdrt with cluster distribution)
  ,{public, {env, "OAUTH2_PUBLIC", "data:LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUlHZk1BMEdDU3FHU0liM0RRRUJBUVVBQTRHTkFEQ0JpUUtCZ1FEZGxhdFJqUmpvZ28zV29qZ0dIRkhZTHVnZFVXQVk5aVIzZnk0YXJXTkExS29TOGtWdzMzY0ppYlhyOGJ2d1VBVXBhckN3bHZkYkg2ZHZFT2ZvdTAvZ0NGUXNIVWZRclNEditNdVNVTUFlOGp6S0U0cVcraksreFFVOWEwM0dVbktIa2tsZStRMHBYL2c2alhaN3IxL3hBSzVEbzJrUStYNXhLOWNpcFJnRUt3SURBUUFCCi0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo="}}
  ,{secret, {env, "OAUTH2_SECRET", "data:LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlDV3dJQkFBS0JnUURkbGF0UmpSam9nbzNXb2pnR0hGSFlMdWdkVVdBWTlpUjNmeTRhcldOQTFLb1M4a1Z3MzNjSmliWHI4YnZ3VUFVcGFyQ3dsdmRiSDZkdkVPZm91MC9nQ0ZRc0hVZlFyU0R2K011U1VNQWU4anpLRTRxVytqSyt4UVU5YTAzR1VuS0hra2xlK1EwcFgvZzZqWFo3cjEveEFLNURvMmtRK1g1eEs5Y2lwUmdFS3dJREFRQUJBb0dBRCtvbkF0VnllNGljN1ZSN1Y1MERGOWJPbndSd05YckFSY0RocTlMV05SclJHRWxFU1lZVFE2RWJhdFhTM01DeWpqWDJlTWh1L2FGNVloWEJ3a3Bwd3hnK0VPbVhlaCtNekw3WmgyODRPdVBia2dsQWFHaFY5YmI2LzVDcHVHYjFlc3lQYllXK1R5MlBDMEdTWmZJWGtYczc2alhBdTlUT0J2RDB5YmMyWWxrQ1FRRHl3ZzJSLzd0M1EyT0UyK3lvMzgyQ0xKZHJsU0xWUk9XS3diNHRiMlBqaFk0WEF3VjhkMXZ5MFJlbnhUQitLNU11NTd1VlNUSHRyTUswR0F0RnI4MzNBa0VBNmF2eDIwT0hvNjFZZWxhLzRrNWtRRHRqRWYxTjBMZkkrQmNXWnR4c1MzakRNM2kxSHAwS1N1NXJzQ1BiOGFjSm81Uk8yNmdHVnJmQXNEY0lYS0MrYlFKQVpaMlhJcHNpdEx5UHB1aU1PdkJielBhdmQ0Z1k2WjhLV3JmWXpKb0kvUTlGdUJvNnJLd2w0QkZvVG9EN1dJVVMraHBrYWd3V2l6KzZ6TG9YMWRiT1p3SkFDbUg1ZlNTakFrTFJpNTRQS0o4VEZVZU9QMTVoOXNRenlkSTh6SlUrdXB2REVLWnNaYy9VaFQvU3lTRE94UTRHLzUyM1kwc3ovT1p0U1djb2wvVU1nUUpBTGVzeSsrR2R2b0lETGZKWDVHQlFwdUZnRmVuUmlSRGFieHJFOU1OVVoyYVBGYUZwK0R5QWUrYjRuRHd1SmFXMkxVUmJyOEFFWmdhN29RajB1WXhjWXc9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo="}}

   %%
   %% timer to reload config (keys)
  ,{reload, {env, "OAUTH2_RELOAD", 60000}}

   %%
   %% default list of roles
  ,{claims,  {env, "OAUTH2_CLAIMS", "uid=true"}}
]},

%%
%%
{oauth2, [
   %%
   %% oauth2 backing service to store oauth2 claims
   %%  * ddb+http://localhost:8000/oauth2pubkey?hashkey=access
   {storage, {env, "OAUTH2_STORAGE", "ephemeral://"}}
]}

].